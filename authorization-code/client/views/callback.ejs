<!DOCTYPE html>
<html>
  <head>
    <title>Processing Authorization</title>
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body>
    <div id="loading" class="loading text-center">
      <h2>Processing Authorization...</h2>
      <p>Exchanging authorization code for access token...</p>
    </div>

    <div id="success" style="display: none">
      <div class="alert success">
        <h2>Authentication Successful! âœ“</h2>
        <p>You have successfully obtained an access token.</p>
      </div>

      <h3>Access Token</h3>
      <div class="code" id="accessTokenDisplay"></div>
      <p>You can now access protected resources using your access token.</p>

      <a href="/" class="button primary">Go to Homepage</a>
    </div>

    <div id="error" style="display: none">
      <div class="alert danger">
        <h2>Error</h2>
        <p id="errorMessage"></p>
      </div>

      <a href="/" class="button primary">Back to Home</a>
    </div>

    <script>
      const authServer = "<%= authServer %>";
      const clientId = "<%= clientId %>";
      const clientSecret = "<%= clientSecret %>";
      const redirectUri = "<%= redirectUri %>";
      const code = "<%= code %>";

      async function exchangeCodeForToken() {
        try {
          const response = await fetch(`${authServer}/oauth/token`, {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              Authorization: "Basic " + btoa(`${clientId}:${clientSecret}`),
            },
            body: new URLSearchParams({
              grant_type: "authorization_code",
              code: code,
              redirect_uri: redirectUri,
            }),
          });

          const data = await response.json();

          if (data.error) {
            showError(`Token Error: ${data.error_description || data.error}`);
            return;
          }

          // You most probably shouldn't be storing the access token in localStorage
          // in a production application. This is just for demonstration purposes.
          localStorage.setItem("access_token", data.access_token);

          showSuccess(data.access_token);
        } catch (error) {
          showError(`Error: ${error.message}`);
        }
      }

      function showSuccess(accessToken) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("accessTokenDisplay").textContent =
          accessToken.substring(0, 20) + "...";
        document.getElementById("success").style.display = "block";
      }

      function showError(message) {
        document.getElementById("loading").style.display = "none";
        document.getElementById("errorMessage").textContent = message;
        document.getElementById("error").style.display = "block";
      }

      exchangeCodeForToken();
    </script>
  </body>
</html>
